<!DOCTYPE html>
<html lang="en">
<head>
<title>nfsu2-re</title>
<style>
body {
	font-family: Arial,Tahoma,sans-serif;
}
table td {
	padding: .4em;
}
body > div {
	padding: 1em;
	border: 1px solid #efefef;
	outline: 1px solid #d0d0d0;
	max-width: 60em;
	margin: auto;
}
body > div + div {
	margin-top: 1em;
}
.center {
	text-align: center;
}
code {
	display: inline-block;
	background: #dfdfdf;
	padding: .2em;
	margin: 0 .2em;
	border-radius: 2px;
}
pre {
	border:2px solid #CDCDCD;
	padding: 0.5em;
	white-space: pre-wrap;
}
pre.ida {
	background:#fff;
	color:#000080;
	font-weight: bold;
}
pre.ida span.t {
	color:#000;
}
pre.ida span.c {
	color:#808080;
}
pre.ida span.i {
	color:#0000FF;
}
pre.ida span.n {
	color:#008000;
}
pre.ida span.hi {
	background:#FFFF00;
}
h2 a, h3 a {
	color: #A0A0A0;
}
</style>
</head>
<body>
	<div style="background:#ABABAB">
		<h1>nfsu2-re</h1>
	</div>
	<div>
		<h2 id="prologue">Prologue</h2>
		<p>
			This is just me documenting while I have fun attempting to reverse-engineer the game
			Need For Speed Underground 2, otherwise knows as nfsu2.
		</p>
		<p>
			This normally belongs to
			<a href="https://github.com/yugecin/nfsu2-re">https://github.com/yugecin/nfsu2-re</a>
		</p>
	</div>
	<div>
		<h2 id="index">Index</h2>
		<ul>
			<li><a href="#prologue">Prologue</a></li>
			<li><a href="#index">Index</a></li>
			<li><a href="#injectedcode">Injected code</a></li>
			<li><a href="#registry">Registry</a></li>
			<li>
				<a href="#language">Language</a>
				<ul>
					<li><a href="#language_metadata">Language metadata</a></li>
					<li><a href="#language_files">Language files</a></li>
				</ul>
			</li>
			<li>
				<a href="#displaysettings">Display settings</a>
				<ul>
					<li><a href="#displaysettingstodo">Todo</a></li>
				</ul>
			</li>
			<li><a href="#consoleleftover">Console leftovers</a></li>
			<li>
				<a href="#hashfuncs">Hash functions</a>
				<ul>
					<li><a href="#hashmess">Messing with the hash results</a></li>
				</ul>
			</li>
			<li><a href="#debugprint">Debug print</a></li>
			<li>
				<a href="#ui">UI</a>
				<ul>
					<li>
						<a href="#ui_dialog">Dialogs</a>
						<ul>
							<li><a href="#ui_dialog_getfngfordialog">GetFNGForDialog</a></li>
						</ul>
					</li>
				</ul>
			</li>
		</ul>
	</div>
	<div>
		<h2 id="injectedcode">Injected code <a href="#injectedcode">#</a></h2>
		<p>
			The code for all injected things I did can be found in <code>nfsu2-re-hooks/main.c</code>.
			It's configured as a VC2005 project in a VC2005 solution. The project emits a compiled file
			to <code>..\NeedForSpeed U2\scripts\nfsu2-re-hooks.asi</code>. I'm using the
			<a href="https://github.com/ThirteenAG/Ultimate-ASI-Loader/releases">Ultimate ASI Loader by
			ThirteenAG</a>, which loads the library nicely for me (download the ZIP and place the dll
			in the game folder, name it <code>dinput8.dll</code>).
		</p>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="registry">Registry <a href="#registry">#</a></h2>
		<p>
			Many values (mainly display settings are loaded/saved in procs: (TODO check the XREFs on these)
		</p>
		<ul>
			<li><code>0x5BEA20 - LoadDisplaySettings</code> only called once, at boot</li>
			<li><code>0x5BEEA0 - SaveDisplaySettings</code> called multiple times, TODO</li>
		</ul>
		<p>
			They are saved in key <code>Software\EA Games\Need for Speed Underground 2</code> in
			<code>HKEY_CURRENT_USER</code>.
			On my machine this translates to:
			<code>HKEY_CURRENT_USER\Software\Classes\VirtualStore\MACHINE\SOFTWARE\Wow6432Node\EA
			Games\Need for Speed Underground 2</code>
			I'm guessing the extra path in between is because of WOW64.
			<table border="1">
			<thead>
			<tr><th>Variable address</th><th>Key</th><th>Notes</th></tr>
			</thead>
			<tbody>
			<tr>
				<td><code>0x870CB0</code></td>
				<td><code>VERSION</code>
				</td><td>Not a display setting</td>
			</tr>
			<tr>
				<td><code>0x870CB4</code></td>
				<td><code>SIZE</code></td>
				<td>Not a display setting. Seems unused (no XREFs other than save/load procs),
				ALTHOUGH its value is set (to 120)? TODO INVESTIGATE!</td>
			</tr>
			<tr>
				<td><code>0x870CB8</code></td>
				<td><code>g_CarEnvironmentMapEnable</code></td>
				<td><code>_optCarReflectionUpdateRate</code></td>
			</tr>
			<tr>
				<td><code>0x870CBC</code></td>
				<td><code>g_CarEnvironmentMapUpdateData</code></td>
				<td><code>_optCarReflectionDetail</code></td>
			</tr>
			<tr>
				<td><code>0x870CC0</code></td>
				<td><code>g_CarShadowEnable</code></td>
				<td><code>_optCarShadowNeon</code></td>
			</tr>
			<tr>
				<td><code>0x870CC4</code></td>
				<td><code>g_CarHeadlightEnable</code></td>
				<td><code>_optCarHeadlight</code></td>
			</tr>
			<tr>
				<td><code>0x870CC8</code></td>
				<td><code>g_CarLightingEnable</code></td>
				<td>Seemingly unused? TODO</td>
			</tr>
			<tr>
				<td><code>0x870CCC</code></td>
				<td><code>g_CarDamageEnable</code></td>
				<td>Seemingly unused? TODO</td>
			</tr>
			<tr>
				<td><code>0x870CD0</code></td>
				<td><code>g_CrowdEnable</code></td>
				<td><code>_optCrowds</code></td>
			</tr>
			<tr>
				<td><code>0x870CD4</code></td>
				<td><code>g_RoadReflectionEnable</code></td>
				<td><code>_optWorldReflectionDetail</code></td>
			</tr>
			<tr>
				<td><code>0x870CD8</code></td>
				<td><code>g_FogEnable</code></td>
				<td><code>_optFog</code></td>
			</tr>
			<tr>
				<td><code>0x870CDC</code></td>
				<td><code>g_MotionBlurEnable</code></td>
				<td><code>_optMotionBlur</code></td>
			</tr>
			<tr>
				<td><code>0x870CE0</code></td>
				<td><code>g_LightStreaksEnable</code></td>
				<td><code>_optLightTrails</code></td>
			</tr>
			<tr>
				<td><code>0x870CE4</code></td>
				<td><code>g_LightGlowEnable</code></td>
				<td><code>_optLightGlow</code></td>
			</tr>
			<tr>
				<td><code>0x870CE8</code></td>
				<td><code>g_AnimatedTextureEnable</code></td>
				<td><code>_optAnimatedTextureEnable</code><br/>
				doesn't seem to be in display menu</td>
			</tr>
			<tr>
				<td><code>0x870CEC</code></td>
				<td><code>g_ParticleSystemEnable</code></td>
				<td><code>_optParticleSystem</code></td>
			</tr>
			<tr>
				<td><code>0x870CF0</code></td>
				<td><code>g_DepthOfFieldEnable</code></td>
				<td><code>_optDepthOfField</code></td>
			</tr>
			<tr>
				<td><code>0x870CF4</code></td>
				<td><code>g_WorldLodLevel</code></td>
				<td><code>_optWorldDetail</code></td>
			</tr>
			<tr>
				<td><code>0x870CF8</code></td>
				<td><code>g_CarLodLevel</code></td>
				<td><code>_optCarGeometryDetail</code></td>
			</tr>
			<tr>
				<td><code>0x870CFC</code></td>
				<td><code>g_OverBrightEnable</code></td>
				<td><code>_optOverBright</code></td>
			</tr>
			<tr>
				<td><code>0x870D00</code></td>
				<td><code>g_BleachByPassEnable</code></td>
				<td><code>_optEnchancedContrast</code></td>
			</tr>
			<tr>
				<td><code>0x870D04</code></td>
				<td><code>g_TintingEnable</code></td>
				<td><code>_optTinting</code></td>
			</tr>
			<tr>
				<td><code>0x870D08</code></td>
				<td><code>g_FSAALevel</code></td>
				<td><code>_optFSAALevel</code></td>
			</tr>
			<tr>
				<td><code>0x870D0C</code></td>
				<td><code>g_HorizonFogEnable</code></td>
				<td><code>_optHorizonFog</code></td>
			</tr>
			<tr>
				<td><code>0x870D10</code></td>
				<td><code>g_RainEnable</code></td>
				<td><code>_optRainSplatter</code></td>
			</tr>
			<tr>
				<td><code>0x870D18</code></td>
				<td><code>g_TextureFiltering</code></td>
				<td><code>_optTextureFiltering</code></td>
			</tr>
			<tr>
				<td><code>0x870D1C</code></td>
				<td><code>g_RacingResolution</code></td>
				<td><code>_optRacingResolutionIdx</code></td>
			</tr>
			<tr>
				<td><code>0x87099C</code></td>
				<td><code>g_PerformanceLevel</code></td>
				<td><code>_optLevelOfDetail</code></td>
			</tr>
			<tr>
				<td><code>0x870D24</code></td>
				<td><code>g_VSyncOn</code></td>
				<td><code>_optVsync</code></td>
			</tr>
			</tbody>
			</table>
		</p>
		<hr/>
		<h3>SomethingReadSpecialRegistrySettings - 0x5B76F0</h3>
		<p>
			This one is invoked on boot, and seems to load a special key that I haven't seen before:
			<code>Software\Electronic Arts\EA Games\Need for Speed Underground 2\er</code>. This key
			is not present on my system, so this seems interesting.
		</p>
		<pre>
HKEY key;
DWORD type, lenData;
if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, "Software\\E...2\\er", 0, KEY_READ, &amp;key)) {
	type = 1; // REG_SZ, a null-terminated string
	lenData = 21;
	if (RegQueryValueExA(key, 0, 0, &amp;type, &amp;buf_86FF8C, &amp;lenData)) {
		buf_86FF8C[20] = 0;
	} else {
		buf_86FF8C[0] = 0;
	}
}
RegCloseKey(&amp;key);
// buf_86FF8C is only used at sub_588770, 0x58887A, TODO!</pre>
		<p>
			Then it loads more stuff from the normal key:
		</p>
		<p>
			<code>Install Dir</code> is read. If set, passed to (winapi) <code>GetLongPathNameA</code>,
			and if that succeeds, the value is copied to buffer at <code>0x86E9B4</code>. There are no
			XREFs, so it's unused?
		</p>
		<p>
			<code>CD Drive</code> is read. If set, passed to (winapi) <code>GetLongPathNameA</code>,
			passed to (winapi) <code>GetLastError</code> and if that succeeds, the value is copied to
			buffer at <code>86E8B0</code>. That one is used, TODO.
		</p>
		<p>
			<code>NotFirstTime</code> is read. If set, DWORD at <code>0x870D20</code> gets set to 1,
			otherwise 0. It doesn't check the value in the register key. Then 1 is written to the
			register key. TODO this is used in one place.
		</p>
		<p>
			<code>CacheSize</code> is read. If set, proc at <code>0x75D65B</code> is called with the
			value. TODO what is this? proc has plenty XREFs and is just a jmp to another proc that
			has even more XREFs.
		</p>
		<p>
			<code>SwapSize</code> is read. If set, proc at <code>0x75D65B</code> is called with the
			value. TODO what is this? proc has plenty XREFs and is just a jmp to another proc that
			has even more XREFs.
		</p>
		<p>
			<code>Language</code> is read. Then it does something with looping through a language.
			This took some deciphering but I found out that there is some struct with language
			information and associated data. See <a href="#language_metadata">Language metadata</a>.
		</p>
		<p>
			<code>StreamingInstall</code> is read. This one seems weird, as it seems like it passes
			the value and the offset to a random location in the code segment to a proc that looks
			like a strcmp function? TODO.
		</p>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="language">Language <a href="#language">#</a></h2>
		<p>
			There seems to be no way to change the language, except for changing the value
			in the registry? See <a href="#registry">Registry</a>. Perhaps it is only set
			when the game is installed?
		</p>
		<hr/>
		<h3 id="language_metadata">Language metadata <a href="#language_metadata">#</a></h3>
		<p>
			Thanks to code where it reads the Registry, I found following data:
		</p>
		<pre>
struct LanguageData {
	char *pName;
	int val1; //??
	int val2; //??
};</pre>
		<p>
			Data can be found at <code>0x7FCA08</code>:
		</p>
		<pre>
struct LanguageData languageData[] = {
/*0x7FCA08*/ { "English US",		0,	0 },
/*0x7FCA14*/ { "English UK",		0,	5 },
/*0x7FCA20*/ { "French",		1,	6 },
/*0x7FCA2C*/ { "German",		2,	7 },
/*0x7FCA38*/ { "Italian",		3,	8 },
/*0x7FCA44*/ { "Spanish",		4,	9 },
/*0x7FCA50*/ { "Swedish",		6,	5 },
/*0x7FCA5C*/ { "Danish",		7,	5 },
/*0x7FCA68*/ { "Dutch",			5,	5 },
/*0x7FCA74*/ { "Korean",		8,	2 },
/*0x7FCA80*/ { "Chinese (Traditional)",	9,	4 },
/*0x7FCA8C*/ { "English China",		9,	11 },
/*0x7FCA98*/ { "Japanese",		10,	3 },
/*0x7FCAA4*/ { "Thai",			11,	12 },
/*0x7FCAB0*/ { 0,			0,	0 },
};</pre>
		<p>

		</p>
		<p>
			The value stored in the registry for <code>Language</code> is checked against
			all language strings in the above data. The matching language's
			<code>val1</code> gets stored in <code>0x7FCA00</code> (TODO), or 0 when the
			name stored in the registry didn't match any names.
		</p>
		<p><strong>00512520 LoadLanguageAtBoot TODO</strong></p>
		<p><strong>07983D0 aLanguageselect db 'LanguageSelectScreen',0 TODO</strong></p>
		<h3 id="language_files">Language files <a href="#language_files">#</a></h3>
		<p>
			Files
		</p>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="displaysettings">Display settings <a href="#displaysettings">#</a></h2>
		<p>
			TODO. I was writing this when I got distracted by the language stuff.
		</p>
		<hr/>
		<h3 id="displaysettingstodo">Todo <a href="#displaysettingstodo">#</a></h3>
		<p>
			Where are these used:
		</p>
		<ul>
			<li><code>0x5BE190 StoreOptLightGlowSetToZero</code> 1 XREF</li>
			<li><code>0x5BE1B0 RestoreOptLightGlow</code>: 1 XREF</li>
			<li><code>0x5BE1C0 GetWorldDetailClampBetween0And2</code>: 1 XREF</li>
		</ul>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="consoleleftover">Console leftovers <a href="#consoleleftover">#</a></h2>
		<p>
			<em>Note: console as in somewhere you type in, not a videogame console</em>
		</p>
		<p>
			In the hooks project, I "enabled" this console in the functions <code>initConsolePOC</code>
			in the file <code>nfsu2-re-hooks/main.c</code>. As it doesn't seem to be used anywhere, the
			only effect you can see is that whatever you type is written into the
			<code>console_real_text</code> buffer (use CheatEngine or something you like to inspect it).
		</p>
		<p>
			All names below were chosen by me.
		</p>
		<h3>ConsoleConsumeKey - 0x5C8320</h3>
		<p>
			When looking at the <code>MainWndProc</code> (which is not to hard too find because it's
			passed in a struct to <code>RegisterClassExA</code>), I saw a call to a function that
			is called on every <code>WM_CHAR</code> event. The function does nothing when the value
			in <code>0x8709BC</code> is zero, and there are no write references to it, so it seems
			like it will always be zero. I called this <code>consoleEnabledFlag</code>.
		</p>
		<p>
			First it seems like the input is dropped if it's a <code>CR</code> (carriage return) and
			when the value at <code>0x8709C4</code> is non-zero. Again, this is always zero so CR's
			are never dropped. I called this <code>consoleIgnoreNextCR</code>.
		</p>
		<p>
			Then it has four different handlers. The first one handles a backspace character, second
			one does escape, third one does tab and CR, and the last one does everything else. Basically
			one character is deleted when pressing backspace and one character is added in all other
			cases. I named following variables:
		</p>
		<ul>
			<li><code>0x8709B8 - consoleTextCaretPosition - int</code></li>
			<li><code>0x8709C0 - consoleTextStringMaxLength - int</code></li>
			<li><code>0x8709B0 - consoleTextString - char*</code></li>
			<li><code>0x8709B4 - consoleTextStringLength - int</code></li>
			<li><code>0x8709BC - consoleEnabledFlag - int</code></li>
		</ul>
		<p>
			Basically, on backspace it checks if <code>consoleTextCaretPosition</code> is bigger than
			zero, copies everything in <code>consoleTextString</code> starting from
			<code>consoleTextCaretPosition</code> to a zero byte into a newly allocated buffer,
			decrements <code>consoleTextCaretPosition</code> and <code>consoleTextStringLength</code>,
			and copies everything from the allocated buffer back into <code>consoleTextString</code> at
			position <code>consoleTextCaretPosition</code>.
		</p>
		<p>
			When inserting, it checks if <code>consoleTextStringLength</code> is less than
			<code>consoleTextStringMaxLength</code>, copies everything in
			<code>consoleTextString</code> starting from <code>consoleTextCaretPosition</code>
			to a zero byte into a newly allocated buffer, inserts the character in
			<code>consoleTextString</code> at position <code>consoleTextCaretPosition</code>, increments
			<code>consoleTextCaretPosition</code> and <code>consoleTextStringLength</code> by one,
			and copies everything from the allocated buffer back into <code>consoleTextString</code>
			at position <code>consoleTextCaretPosition</code>.
		</p>
		<ul>
			<li>Backspace: delete character before caret</li>
			<li>Escape: insert zero byte</li>
			<li>Tab and CR: insert LF</li>
			<li>Other: insert char if it's <code>a-z</code> or <code>A-Z</code> or <code>0-9</code> or,
			if <code>0x80057E</code> is zero, <code>_</code> or <code>@</code> or <code>.</code> or
			<code>-</code>. If none of these pass, do a check for more keys as described below</li>
		</ul>
		<h4>A hardcoded key check - 0x5BF260</h4>
		<p>
			At the end of looking if a character is valid, when it hasn't passed any of the criteria
			above, it checks one last function if <code>0x8709C7</code> is <code>1</code>. The function
			seems to check if the key is one of 55 configured values and if so, the char is accepted.
			The C-ified code looks like this:
		</p>
		<pre>
int ConsoleIsCharOneOfTheseHardcodedValues(unsigned char value)
{
	unsigned char values[55] = {
		' ', '.', ',', '_', '@', '-', '`', '=', '[', ']', '\\',
		';', '\'', '/', '&lt;', '&gt;', '?', ':', '"', '{', '}', '|',
		'+', '(', ')', '*', '&amp;', '%', '#', '!', '~', 0xE5, 0xE4,
		0xE0, 0xE2, 0xEB, 0xE8, 0xE9, 0xEA, 0xEF, 0xEE, 0xF6,
		0xF4, 0xFC, 0xF9, 0xFB, 0xE7, 0x9C, 0xF2, 0xEC, 0xC5,
		0xC4, 0xD6, 0xDC, 0xA7
	};
	int i;

	for (i = 0; i &lt; 55; i++) {
		if (values[i] == value) {
			return 1;
		}
	}
	return 0;
}</pre>
		<h3>ConsoleMoveCaret - 0x5BF3A0</h3>
		<p>
			This function is also called from <code>MainWndProc</code>, this time when a
			<code>WM_KEYDOWN</code> message is received. One parameter is passed based on the keycode
			of the event:
		</p>
		<ul>
			<li><code>VK_LEFT</code>: <code>-1</code></li>
			<li><code>VK_RIGHT</code>: <code>1</code></li>
			<li><code>VK_HOME</code>: <code>-consoleTextStringMaxLength</code></li>
			<li><code>VK_END</code>: <code>consoleTextStringMaxLength</code></li>
		</ul>
		<p>
			This is the only other function that checks if <code>consoleEnabledFlag</code> is non-zero.
		</p>
		<p><a href="#index">Index</a></p>
	</td></tr>
	<tr><td>
		<h2 id="hashfuncs">Hash functions <a href="#hashfuncs">#</a></h2>
		<p>
			While scrolling and looking at references to some strings, I found some parts that look like
			following excerpt:
		</p>
		<pre class="ida">
<span class="t">.text:005121AE</span>     push    offset <span class="i">aGenericdialo_2</span> <span class="c">; "GenericDialog_Animate_SMALL.fng"</span>
<span class="t">.text:005121B3</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:005121B8</span>     add     esp, <num>4</num>
<span class="t">.text:005121BB</span>     cmp     esi, eax
<span class="t">.text:005121BD</span>     jz      short loc_512218
<span class="t">.text:005121BF</span>     push    offset <span class="i">aGenericdialog_</span> <span class="c">; "GenericDialog_SMALL.fng"</span>
<span class="t">.text:005121C4</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:005121C9</span>     add     esp, <num>4</num>
<span class="t">.text:005121CC</span>     cmp     esi, eax
<span class="t">.text:005121CE</span>     jz      short loc_512218
<span class="t">.text:005121D0</span>     push    offset <span class="i">aGenericdialo_3</span> <span class="c">; "GenericDialog_Animate_MED.fng"</span>
<span class="t">.text:005121D5</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:005121DA</span>     add     esp, <num>4</num>
<span class="t">.text:005121DD</span>     cmp     esi, eax
<span class="t">.text:005121DF</span>     jz      short loc_512218
<span class="t">.text:005121E1</span>     push    offset <span class="i">aGenericdialo_4</span> <span class="c">; "GenericDialog_MED.fng"</span>
<span class="t">.text:005121E6</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:005121EB</span>     add     esp, <num>4</num>
<span class="t">.text:005121EE</span>     cmp     esi, eax
<span class="t">.text:005121F0</span>     jz      short loc_512218
<span class="t">.text:005121F2</span>     push    offset <span class="i">aGenericdialo_5</span> <span class="c">; "GenericDialog_Animate_LARGE.fng"</span>
<span class="t">.text:005121F7</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:005121FC</span>     add     esp, <num>4</num>
<span class="t">.text:005121FF</span>     cmp     esi, eax
<span class="t">.text:00512201</span>     jz      short loc_512218
<span class="t">.text:00512203</span>     push    offset <span class="i">aGenericdialo_0</span> <span class="c">; "GenericDialog_LARGE.fng"</span>
<span class="t">.text:00512208</span>     call    <span class="hi">sub_505450</span>
<span class="t">.text:0051220D</span>     add     esp, <num>4</num>
<span class="t">.text:00512210</span>     cmp     esi, eax
<span class="t">.text:00512212</span>     jz      short loc_512218</pre>
		<p>
			The proc at <code>0x505450</code> doesn't look very complicated; it has one argument and
			doesn't perform any calls. It dereferences the given argument and increment its position,
			until a zero has been found. While it's doing that, eax is modified based on the read value.
			So I assumed it is some hashing function and hooked it to see what kind of things are passed
			through it.
		</p>
		<p>
			As it turns out, it gets called many, many times.
		</p>
		<pre>
<strong>time        input result</strong>
53.42743683 GenericDialog_SMALL.fng 6962C0CD
53.42753220 UI_PC_Help_Bar.fng 33AC1CB4
53.42756271 OL_ICON_GROUP 2BAC0CEE
53.42758179 UI_PC_Help_Bar.fng 33AC1CB4
53.42760086 Hide 0016A259
53.42761993 UI_Main.fng C343126A
53.42766190 GarageMain.fng 4CDD8B14
53.42769241 GarageMain.fng 4CDD8B14
53.42771149 GarageMain.fng 4CDD8B14
53.42773056 GenericDialog.fng F68A7675
53.42774963 UI_GenericParts_Browser.fng AF09F84F
53.42776871 GenericDialog.fng F68A7675
53.42779160 GenericDialog_SMALL.fng 6962C0CD
53.42781067 UI_PC_Help_Bar.fng 33AC1CB4
53.42782974 UI_Main.fng C343126A
53.42784882 GarageMain.fng 4CDD8B14
53.42790222 UI_MagazineBack.fng FA8CC482
53.42796707 GenericDialog_SMALL.fng 6962C0CD
53.42798615 UI_PC_Help_Bar.fng 33AC1CB4
53.42800522 UI_Main.fng C343126A
53.42802429 GarageMain.fng 4CDD8B14
53.42922211 GenericDialog_SMALL.fng 6962C0CD
53.42924881 UI_PC_Help_Bar.fng 33AC1CB4
53.42926788 UI_Main.fng C343126A
53.42928696 GarageMain.fng 4CDD8B14</pre>
		<p>
			The excerpt above is probably from one cycle in the update loop, and is repeated a lot.
		</p>
		<p>
			Some time later I found a very similar looking proc at <code>0x43DB50</code>, so I copied
			the previous hook for this function. This one gets called many times seemingly at startup
			and when car parts or maps get loaded.
		</p>
		<p>
			When writing this I took a better look at the procedures and saw that the only difference
			really is that the first one is case insensitive while the second one is case sensitive.
			In the <code>0x505450</code> one, it checks for every character if it is in the range
			<code>'a'-'z'</code> and subtracts <code>0x20</code> if so, making the character uppercase
			before updating the hash.
		</p>
		<p>
			See <a href="hashes.txt">hashes.txt</a> (~227KB) for list of hashes, each line is formatted
			as <code>hash\tinput\tresult\tproc\n</code>. It is the result of a dump of short 8 minute
			menu browsing/driving. This output was piped to <code>sort | uniq</code>, the original output
			was 277MB. I thought a tab character was a good separator but the first two entries have tab
			characters...
		</p>
		<p>
			How I collected these can be seen in <code>nfsu2-re-hooks/main.c</code>, starting
			from functions <code>SomeHashCI505450HookPre</code> and
			<code>SomeHashCS43DB50HookPre</code>.
		</p>
		<p><a href="#index">Index</a></p>
		<hr/>
		<h3 id="hashmess">Messing with hash results <a href="#hashmess">#</a></h3>
		<p>
			I had an impulse to try to return different results for certain hashes. For example, return
			the result of <code>FIRETRUCK</code> when the input is <code>240SX</code>. The result is ..
			difficult to describe. Here's some short points:
		</p>
		<ul>
			<li>Browsing to the stock 240sx to customize shows an empty spot, no car</li>
			<li>Selecting the stock car to customize will suddenly swap to the firetruck model</li>
			<li>I can modify the firetruck, I can't select any bumpers but I can choose spoilers,
			although it does nothing</li>
			<li>Changing wheels/spinners/hydraulics does show</li>
			<li>Then going out of the customization menu crashes the game
			(this includes going to performance tuning)</li>
		</ul>
		<p class="center">
			<img src="FIRETRUCK.GIF"/><br/>Hop hop skippity hop
		</p>
		<ul>
			<li>Browsing a previously customized 240sx only shows the wheels of the car</li>
			<li>If the wheels were not customized, it shows black rectangles as wheels and the game
			crashes when I try to customize the wheels/spinners</li>
			<li>Selecting the customized car to customize doesn't change anything special, still only wheels</li>
			<li>Only the firetruck customization options can be selected</li>
			<li>Choosing a spoiler shows the spoiler in the center of the car</li>
			<li>When going out of a category (like Body parts), the car switches to the same car but the wheels
			at the position where they should be for the firetruck</li>
			<li>When going outside the customize menu now, the car's brand is a <code>*</code> symbol</li>
			<li>When going to a different car and back, the firetruck model shows</li>
			<li>Entering customization again hides the firetruck, only showing the wheels
			(the spoiler is gone?)</li>
			<li>After saving and undoing the swap and restarting the game, the saved car stays a firetruck
			(but the behavior is still the same as described above)</li>
			<li>Using the car to race makes the framerate go down significantly, except when in nose camera
			(you just see headlights driving without a vehicle body)</li>
			<li>It doesn't lag at all in the performance tuning</li>
		</ul>
		<p class="center">
			<img src="FIRETRUCK-DYNO.JPG"/><br/>Here's a dyno chart of the firetruck
		</p>
		<p>
			While the firetruck is unused in the game, I also tried to do this with the taxi, but it gave the
			same results. Then I tried to replace it with a "normal" car, the Mustang.
		</p>
		<ul>
			<li>Browsing a stock 240sx only shows black rectangles for wheels</li>
			<li>When selecting the car, it gets replaced with a mustang, and now I'm customizing a mustang</li>
			<li>The only change I can see is that there are no headlights or taillights</li>
			<li>Going ingame now only shows the front bumper of the car, which is the thing I customized</li>
			<li>Going back to the menu now shows the car with stock headlights and taillights</li>
			<li>Going ingame again now shows the car fully as it should</li>
			<li>Selecting a customized 240sx now shows the doors of a mustang</li>
		</ul>
		<p class="center">
			<img src="MUSTANG.JPG" alt="driving invisible mustang"/><br/>Car?
		</p>
		<p>
			The behavior isn't always the same, just give it a try and see for yourself. Replacing the taxi
			with the ambulance just lags out the game whenever a taxi comes in sight.
		</p>
		<p>
			Check the function <code>SomeHashCS43DB50Print</code> in the file
			<code>nfsu2-re-hooks/main.c</code> to see how I did this, the code to replace cars is in comments.
		</p>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="debugprint">Debug print <a href="#debugprint">#</a></h2>
		<p>
			While scrolling through the data segment, I found these interesting strings:
		</p>
		<pre class="ida">
<span class="c">.rdata:0079B160</span> <span class="i">aDeletingPackag</span> <!--
-->db <span class="n">'Deleting package [%s]'</span>,<span class="n">0Ah</span>,<span class="n">0</span>
<span class="c">.rdata:0079B177</span>                 align <span class="n">4</span>
<span class="c">.rdata:0079B178</span> <span class="i">aUnActivateXX</span>   <!--
-->db <span class="n">'Un-Activate!!! %x %x'</span>,<span class="n">0Ah</span>,<span class="n">0</span>
<span class="c">.rdata:0079B18E</span>                 db <span class="n">2</span> dup(<span class="n">0</span>)
<span class="c">.rdata:0079B190</span> <span class="i">aWillBeUnloaded</span> <!--
-->db <span class="n">'Will be unloaded [%s]'</span>,<span class="n">0Ah</span>,<span class="n">0</span></pre>
		<p>
			Even more interesting is that these strings are using by pushing them on to the stack,
			followed by a call to a specific proc that looks like this:
		</p>
		<pre class="ida">
<span class="t">.text:0050D510</span> <span class="i">sub_50D510  proc near</span>
<span class="t">.text:0050D510</span>                 xor     eax, eax
<span class="t">.text:0050D512</span>                 retn
<span class="t">.text:0050D512</span> <span class="i">sub_50D510  endp</span> </pre>
		<p>
			It appears as if this used to be some kind of debug printf function, so I named it
			<code>SomeDebugPrint</code>. I hooked the function and made it output to a log file,
			see <code>initHook50D510Print</code> in <code>nfsu2-re-hooks/main.c</code>.
		</p>
		<p>
			It also seems to pass data that is not a pointer to a string. I'm guessing since the
			implementation of this function was removed (and now just returns zero), and there
			were probably other removed functions, so some calls that are supposed to be done
			to different functions may now all point to this one function that also happened to
			be used for the debug print stuff. My simple solution is to check if the first passed
			argument points to memory in the data section, and print if so.
		</p>
		<p>
			I did a short session browsing customization options and performance tuning with this
			enabled, the results can be seen in the log file
			<a href="debugstring50D510.txt">debugstring50D510.txt</a>. Each line is formatted as
			<code>debugstr\t50D510\tcallee\tstring\n</code>. Here is a 'small' excerpt:
		</p>
		<pre>
DIALOG :: --------- ShowDialog -----------
DIALOG :: |_ Do you want to convert your trunk to carbon fiber?
DIALOG :: Oh shit - the control mask is zero.  This is bad.  Try to use Top Package's control mask.
DIALOG ::  |_ TopPackage = UI_GenericParts_Browser.fng, mask = 0.
DIALOG ::    |_ Crap - mask is zero, forcing to 0xff.
DIALOG :: Success : Control mask = 255, Handle = 2
DIALOG :: --------- ShowDialog Finished -----------
Init Package GenericDialog_SMALL.fng
DIALOG :: Constructor
Joy Event: FEPad_Accept[0]
Joy Event: FEPad_Accept[0]
Joy Event: FEPad_Back[1]
Joy Event: FEPad_Back[1]
DIALOG :: Tick, ReturnWithMessage Set, Dismissing: [GenericDialog_SMALL.fng] [b4623f67]
DIALOG :: DismissDialog.  Handle(2).  Current handle(2)
DIALOG ::  |_ Found, popping.
Queue popping GenericDialog_SMALL.fng
Will unload -----------GenericDialog_SMALL.fng------------------
Will be unloaded [GenericDialog_SMALL.fng]
DIALOG :: Closing, sending message (b4623f67) to (UI_GenericParts_Browser.fng).
Send message[b4623f67] to package [UI_GenericParts_Browser.fng]
Message was queued
Un-Activate!!! 37a52f0 37e69c0
Deleting package [GenericDialog_SMALL.fng]
package[GenericDialog_SMALL.fng] will unload</pre>
		<p>
			Most of the messages seem to be about dialogs, joy (keyboard) events,
			FEng/fng packages (I'm guessing those are ui resources/designs?).
		</p>
		<p><a href="#index">Index</a></p>
	</div>
	<div>
		<h2 id="ui">UI <a href="#ui">#</a></h2>
		<p>
			Names with <code>.FNG</code> seem to be occuring a lot, it seems like that are UI
			resources or some kind of UI widget descriptors.
		</p>
		<p><a href="#index">Index</a></p>
		<hr/>
		<h3 id="ui_dialog">Dialogs <a href="#ui_dialog">#</a></h3>
		<p>
			Thanks to the <a href="#debugprint">debugprint</a> discovery, my attention got grabbed
			by something that looked like dialog code. These leftover debug strings helped so much.
		</p>
		<ul>
			<li><code>0x558020 ShowDialog?</code> seems to be the function to show dialogs.</li>
			<li><code>0x4FF250 Dialog__ctor??</code> initializes memory that was allocated to be a
			dialog, found by XREFing from <code>ShowDialog</code></li>
		</ul>
		<p>
			Someone left a trace here:
		</p>
		<pre class="ida">
<span class="t">.text:005541FC</span>                 call    <span class="i">Dialog__ctor??</span>
<span class="t">.text:00554201</span>                 push    offset <span class="i">aDialogConstruc</span> ; <span class="n">"DIALOG :: Constructor\n"</span>
<span class="t">.text:00554206</span>                 call    <span class="i">SomeDebugPrint</span></pre>
		<p>
			One of the first thing <code>ShowDialog</code> does is calling <code>0x526C40</code>,
			which looks like initializes the dialog maybe? One argument is passed, seemingly the
			dialog name. But then it checks an int at the passed dialog name +324h. Conclusion:
			it's passing a struct with dialog info, of which the first member is the name.
		</p>
		<p><a href="#index">Index</a></p>
		<hr/>
		<h4 id="ui_dialog_getfngfordialog">GetFNGForDialog <a href="#ui_dialog_getfngfordialog">#</a></h4>
		<p>
			This function is only used once, by the <code>ShowDialog</code> function. It checks the
			value at +324h, which seems to be a pointer to a string, looks like maybe a type of dialog?
			It's checked if that value is either <code>NULL</code> or empty string or equal to
			<code>animating</code> or <code>3button</code>. I decided to reimplement that function.
			Fun fact: while doing this I managed to write an infinite loop which caused a BSOD.
		</p>
		<p>
			At the end I decided upon the name <code>GetFNGForDialog</code>. It returns a pointer
			to a string that says what FNG to display for the dialog that was passed. Some values
			are:
		</p>
		<ul>
			<li><code>HelpDialog_SMALL.fng</code> when help dialog flag? and text has less than
			5 linebreaks</li>
			<li><code>HelpDialog_MED.fng</code> when help dialog flag? and not small</li>
			<li><code>GenericDialog_ThreeButton.fng</code> when <code>dialog-&gt;pTypeName</code>
			is <code>3button</code></li>
			<li><code>GenericDialog_SMALL.fng</code></li>
			<li><code>GenericDialog_Animate_SMALL.fng</code></li>
			<li><code>GenericDialog_MED.fng</code></li>
			<li><code>GenericDialog_Animate_MED.fng</code></li>
			<li><code>GenericDialog_LARGE.fng</code></li>
			<li><code>GenericDialog_Animate_LARGE.fng</code></li>
		</ul>
		<p>
			See the <code>do526C40getFNGforDialog</code> function for the complete reimplementation.
		</p>
		<p>
			Here's me messing with the returned value:
		</p>
		<p class="center">
			<img src="dialoghelp.jpg" alt="dialog"/><br/><code>HelpDialog_SMALL.fng</code>
		</p>
		<p class="center">
			<img src="dialoggenericmed.jpg" alt="dialog"/><br/><code>GenericDialog_MED.fng</code>
		</p>
		<p class="center">
			<img src="dialog3button.jpg" alt="dialog"/><br/><code>GenericDialog_ThreeButton.fng</code>
		</p>
		<p class="center">
			<img src="dialoganimate.gif" alt="dialog"/><br/><code>GenericDialog_Animate_SMALL.fng</code>
		</p>
		<p>
			I can't remember seeing this animate style dialog... But when adding some debug prints,
			it seems like the online/LAN play uses this: <code>dialog 'Retrieving updated games
			list^from the server...' has type 'animating'</code> but that dialog disappears so fast
			I probably never noticed it.
		</p>
		<p>
			Then I tried replacing it with something totally different,
			<code>UI_GenericParts_Browser.fng</code>. I half expected the game to crash, so I was
			surprised when it showed me this:
		</p>
		<p class="center">
			<img src="dialoggenericpartsbrowser.jpg" alt="dialog"/><br/>:)</code>
		</p>
		<p>
			Printing the dialog info struct address sadly showed that it wasn't stored in the
			executable itself so it's probably somewhere deep in a bin file.
		</p>
		<hr/>
		<p>
			DialogInfo struct made by looking at all of the above and more:
			(Especially <code>Dialog__ctor</code> at <code>0x4FF250</code> helped here.)
		</p>
		<pre>
struct DialogInfo {
	char text[768];
	int unused300;
	int unused304;
	int unused308;
	int unused30C;
	int unused310;
	int unused314;
	int unused318;
	int unused31C;
	int something320; /*read in 5580EB*/
	char *pTypeName;
	int unused_328;
	char unused_32C;
	char isHelpDialog;
	char unused_32E;
	char something32F; /*set to 0 in 55806D*/
	int something330; /*set to 0 in 558074*/
	int unused334;
};
EXPECT_SIZE(struct DialogInfo, 0x338);
ASSERT_OFFSET(struct DialogInfo, pTypeName, 0x324);
ASSERT_OFFSET(struct DialogInfo, isHelpDialog, 0x32D);</pre>
		<p><a href="#index">Index</a></p>
	</div>
</body>
</html>
